datagrids:
    oro-website-search-result-history-grid:
        extended_entity_name: Oro\Bundle\WebsiteSearchBundle\SearchResult\Entity\SearchResultHistory
        acl_resource: oro_website_search_result_history_view
        options:
            entityHint: oro.websitesearch.searchresulthistory.entity_plural_label
        properties:
            id: ~
        source:
            type: orm
            query:
                select:
                    - e.id
                    - e.searchTerm
                    - e.resultType
                    - e.resultsCount
                    - e.createdAt
                    - website.name as websiteName
                    - localization.name as localizationName
                    - customer.name as customerName
                    - 'TRIM(CONCAT(COALESCE(CONCAT(CAST(customerUser.namePrefix as string), '' ''), ''''), COALESCE(CONCAT(CAST(customerUser.firstName as string), '' ''), ''''), COALESCE(CONCAT(CAST(customerUser.middleName as string), '' ''), ''''), COALESCE(CONCAT(CAST(customerUser.lastName as string), '' ''), ''''), COALESCE(CAST(customerUser.nameSuffix as string), ''''))) as customerUserTitle'
                from:
                    - { table: 'Oro\Bundle\WebsiteSearchBundle\SearchResult\Entity\SearchResultHistory', alias: e }
                join:
                    left:
                        - { join: e.website, alias: website }
                        - { join: e.localization, alias: localization }
                        - { join: e.customer, alias: customer }
                        - { join: e.customerUser, alias: customerUser }
        columns:
            searchTerm:
                label: oro.websitesearch.searchresulthistory.search_term.label
            resultType:
                label: oro.websitesearch.searchresulthistory.result_type.label
            resultsCount:
                label: oro.websitesearch.searchresulthistory.results_count.label
                type: twig
                frontend_type: html
                template: '@OroWebsiteSearch/Datagrid/searchResult.html.twig'
            createdAt:
                label: oro.websitesearch.searchresulthistory.created_at.label
                frontend_type: datetime
            websiteTitle:
                label: oro.websitesearch.searchresulthistory.website.label
            localizationTitle:
                label: oro.websitesearch.searchresulthistory.localization.label
            customerTitle:
                label: oro.websitesearch.searchresulthistory.customer.label
            customerUserTitle:
                label: oro.websitesearch.searchresulthistory.customer_user.label
        sorters:
            columns:
                resultType:
                    data_name: e.resultType
                resultsCount:
                    data_name: e.resultsCount
                websiteTitle:
                    data_name: websiteTitle
                localizationTitle:
                    data_name: localizationTitle
                customerTitle:
                    data_name: customerTitle
                customerUserTitle:
                    data_name: customerUserTitle
                searchTerm:
                    data_name: e.searchTerm
                createdAt:
                    data_name: e.createdAt
            default:
                createdAt: DESC
        filters:
            columns:
                searchTerm:
                    data_name: e.searchTerm
                    type: string
                    case_insensitive: false
                    value_conversion: mb_strtoupper
                resultType:
                    data_name: e.resultType
                    type: string
                    case_insensitive: false
                    value_conversion: mb_strtoupper
                createdAt:
                    data_name: e.createdAt
                    type: datetime
                resultsCount:
                    data_name: e.resultsCount
                    type: number-range
                localizationTitle:
                    type: string
                    data_name: localization.name
                websiteTitle:
                    type: string
                    data_name: website.name
                customerTitle:
                    type: string
                    data_name: customer.name
                customerUserTitle:
                    type: string
                    data_name: customerUserTitle

    website-search-results-report:
        entity_name: 'Oro\Bundle\ReportBundle\Entity\CalendarDate'
        options:
            entityHint: oro.websitesearch.searchresulthistory.entity_plural_label
            export: true
        source:
            type: orm
            query:
                select:
                    - searchResult.searchTerm AS searchTerm
                    - count(searchResult.searchTerm) as searchNumbers
                    - count(searchResult1.resultType) AS products
                    - count(searchResult2.resultType) AS empty
                from:
                    - { table: 'Oro\Bundle\ReportBundle\Entity\CalendarDate', alias: calendarDate }
                join:
                    left:
                        - join: 'Oro\Bundle\WebsiteSearchBundle\SearchResult\Entity\SearchResultHistory'
                          alias: searchResult
                          conditionType: WITH
                          condition: CAST(calendarDate.date as DATE) = CAST(searchResult.createdAt as DATE)
                        - join: 'Oro\Bundle\WebsiteSearchBundle\SearchResult\Entity\SearchResultHistory'
                          alias: searchResult1
                          conditionType: WITH
                          condition: searchResult1.id = searchResult.id AND searchResult1.resultType = 'product'
                        - join: 'Oro\Bundle\WebsiteSearchBundle\SearchResult\Entity\SearchResultHistory'
                          alias: searchResult2
                          conditionType: WITH
                          condition: searchResult2.id = searchResult.id AND searchResult2.resultType = 'empty'
                groupBy: searchResult.normalizedSearchTermHash
        columns:
            timePeriod:
                label: oro.report.datagrid.column.time_period.label
            searchTerm:
                label: oro.websitesearch.searchresulthistory.search_term.label
                cellClassName: 'direction-ltr'
            searchNumbers:
                label: oro.websitesearch.searchresulthistory.reports.number_of_times_searched.title
            products:
                label: oro.websitesearch.searchresulthistory.reports.number_of_products.title
            empty:
                label: oro.websitesearch.searchresulthistory.reports.number_of_empty_results.title
        sorters:
            columns:
                timePeriod:
                    data_name: timePeriod
                    apply_callback: ['@oro_filter.date_grouping_filter', 'applyOrderBy']
                searchTerm:
                    data_name: searchTerm
                searchNumbers:
                    data_name: searchNumbers
                products:
                    data_name: products
                empty:
                    data_name: empty
            default:
                timePeriod: DESC
        filters:
            columns:
                timePeriod:
                    label: oro.report.datagrid.column.time_period.label
                    type: datetime
                    data_name: searchResult.createdAt
                searchTerm:
                    type: string
                    data_name: searchTerm
                skip_empty_periods:
                    label: oro.report.filter.skip_empty_periods.label
                    type: skip_empty_periods
                    data_name: searchTerm
                    options:
                        field_options:
                            choices:
                                No: 0
                                Yes: 1
                        default_value: Yes
                grouping:
                    label: oro.report.filter.grouping.label
                    type: date_grouping
                    data_name: calendarDate.date
                    column_name: timePeriod
                    calendar_entity: 'Oro\Bundle\ReportBundle\Entity\CalendarDate'
                    target_entity: 'Oro\Bundle\WebsiteSearchBundle\SearchResult\Entity\SearchResultHistory'
                    not_nullable_field: searchResult.id
                    joined_column: createdAt
                    joined_table: joinedTableAlias
                    options:
                        field_options:
                            choices:
                                Day: day
                                Month: month
                                Quarter: quarter
                                Year: year
                        default_value: Day
            default:
                grouping:
                    value: day
                skip_empty_periods:
                    value: 1
